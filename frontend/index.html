<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <meta charset="UTF-8">
    <title>èªéŸ³æ—¥è¨˜</title>
    <style>
        body {
            font-family: sans-serif;
        }

        #loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            color: white;
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 999;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.4s ease;
        }

        #loading.active {
            opacity: 1;
            pointer-events: all;
        }
    </style>
</head>

<body>
    <h1>èªéŸ³æ—¥è¨˜</h1>
    <label for="model">é¸æ“‡æ¨¡å‹ï¼š</label>
    <select id="model">
        <option value="tiny">tiny</option>
        <option value="base" selected>base</option>
        <option value="small">small</option>
        <option value="medium">medium</option>
        <option value="large-v3">large-v3</option>
    </select>
    <br>
    <button id="startBtn">ğŸ™ï¸ é–‹å§‹éŒ„éŸ³</button>
    <button id="stopBtn" disabled>â¹ï¸ åœæ­¢éŒ„éŸ³</button>
    <button id="uploadBtn" disabled>â˜ï¸ ä¸Šå‚³è¾¨è­˜</button>
    <button id="summarizeBtn" disabled>ğŸ“ ç¸½çµ</button> <!-- âœ… æ–°å¢ï¼šç¸½çµæŒ‰éˆ• -->
    <br><br>
    <div id="timer">å°šæœªé–‹å§‹éŒ„éŸ³</div>
    <br>
    <audio id="audioPlayer" controls></audio>

    <p><strong>é€å­—ç¨¿ï¼š</strong></p>
    <p id="transcript">ï¼ˆé€™è£¡æœƒé¡¯ç¤ºèªéŸ³è½‰æ–‡å­—çš„çµæœï¼‰</p>

    <p><strong>æ‘˜è¦ï¼š</strong></p>
    <p id="summary">ï¼ˆé€™è£¡æœƒé¡¯ç¤ºæ•´ç†å¾Œçš„æ‘˜è¦ï¼‰</p> <!-- âœ… æ–°å¢ï¼šæ‘˜è¦é¡¯ç¤ºå€ -->

    <!-- ğŸ”„ Loading ç•«é¢ -->
    <div id="loading">ğŸ”„ è™•ç†ä¸­ï¼Œè«‹ç¨å€™...</div>

    <script>
        let mediaRecorder;
        let audioChunks = [];
        let recordSeconds = 0;
        let timerInterval;

        const startBtn = document.getElementById("startBtn");
        const stopBtn = document.getElementById("stopBtn");
        const uploadBtn = document.getElementById("uploadBtn");
        const summarizeBtn = document.getElementById("summarizeBtn"); // âœ… æ–°å¢
        const audioPlayer = document.getElementById("audioPlayer");
        const transcriptEl = document.getElementById("transcript");
        const summaryEl = document.getElementById("summary"); // âœ… æ–°å¢
        const loading = document.getElementById("loading");
        const timerEl = document.getElementById("timer");

        startBtn.onclick = async () => {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream);
            mediaRecorder.start();
            audioChunks = [];
            recordSeconds = 0;

            timerEl.textContent = "éŒ„éŸ³ä¸­ï¼š0 ç§’";
            timerInterval = setInterval(() => {
                recordSeconds++;
                timerEl.textContent = `éŒ„éŸ³ä¸­ï¼š${recordSeconds} ç§’`;
            }, 1000);

            mediaRecorder.addEventListener("dataavailable", event => {
                audioChunks.push(event.data);
            });

            mediaRecorder.addEventListener("stop", () => {
                clearInterval(timerInterval);
                timerEl.textContent = `éŒ„éŸ³å®Œæˆï¼Œç¸½é•·ï¼š${recordSeconds} ç§’`;

                const audioBlob = new Blob(audioChunks, { type: "audio/webm" });
                audioPlayer.src = URL.createObjectURL(audioBlob);

                uploadBtn.onclick = async () => {
                    const modelSelect = document.getElementById("model");
                    const selectedModel = modelSelect.value;
                    const formData = new FormData();
                    formData.append("audio", audioBlob, "recording.webm");

                    loading.classList.add("active");

                    try {
                        const response = await fetch("http://localhost:8080/api/upload-audio", {
                            method: "POST",
                            body: formData,
                            headers: {
                                "X-Model": selectedModel
                            }
                        });

                        const data = await response.json();
                        transcriptEl.textContent = data.transcript || "âš ï¸ ç„¡æ³•è¾¨è­˜èªéŸ³";

                        if (data.transcript) {
                            summarizeBtn.disabled = false; // âœ… è¾¨è­˜å‡ºä¾†å¾Œï¼Œé–‹æ”¾ç¸½çµæŒ‰éˆ•
                        }
                    } catch (e) {
                        transcriptEl.textContent = "âš ï¸ ç™¼ç”ŸéŒ¯èª¤ï¼š" + e.message;
                    } finally {
                        loading.classList.remove("active");
                    }
                };

                uploadBtn.disabled = false;
            });

            startBtn.disabled = true;
            stopBtn.disabled = false;
        };

        stopBtn.onclick = () => {
            mediaRecorder.stop();
            startBtn.disabled = false;
            stopBtn.disabled = true;
        };

        // âœ… æ–°å¢ summarize æŒ‰éˆ•åŠŸèƒ½
        summarizeBtn.onclick = async () => {
            const doc = transcriptEl.textContent.trim();
            if (!doc || doc === "ï¼ˆé€™è£¡æœƒé¡¯ç¤ºèªéŸ³è½‰æ–‡å­—çš„çµæœï¼‰") {
                alert("âš ï¸ å°šæœªç”¢ç”Ÿé€å­—ç¨¿ï¼");
                return;
            }

            loading.classList.add("active");

            try {
                const response = await fetch("http://localhost:8080/api/summarize", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({ doc })
                });

                const data = await response.json();

                if (data.summary) {
                    // é€™é‚Šç”¨ marked å¥—ä»¶æŠŠ markdown è½‰æˆ HTML
                    summaryEl.innerHTML = marked.parse(data.summary);
                } else {
                    summaryEl.textContent = "âš ï¸ ç„¡æ³•ç”¢ç”Ÿæ‘˜è¦";
                }

            } catch (e) {
                summaryEl.textContent = "âš ï¸ æ‘˜è¦éŒ¯èª¤ï¼š" + e.message;
            } finally {
                loading.classList.remove("active");
            }
        };
    </script>
</body>

</html>